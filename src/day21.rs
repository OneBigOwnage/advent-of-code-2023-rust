use std::collections::HashSet;

#[derive(Debug, Clone, Copy, PartialEq, Eq, PartialOrd, Ord, Hash)]
enum SquareType {
    Start,
    Garden,
    Rocks,
}

#[derive(Debug, Clone, Copy, PartialEq, Eq, PartialOrd, Ord, Hash)]
struct Point {
    x: usize,
    y: usize,
}

impl Into<VirtualPoint> for Point {
    fn into(self) -> VirtualPoint {
        VirtualPoint {
            x: self.x as i64,
            y: self.y as i64,
        }
    }
}

#[derive(Debug, Clone, Copy, PartialEq, Eq, PartialOrd, Ord, Hash)]
struct VirtualPoint {
    x: i64,
    y: i64,
}

#[derive(Debug, Clone, PartialEq, Eq, PartialOrd, Ord)]
struct Garden {
    squares: Vec<Vec<SquareType>>,
    width: usize,
    height: usize,
    start: Point,
}

impl Garden {
    fn get_bounded_neighbors(&self, point: Point) -> Vec<Point> {
        let mut neighbors = vec![];

        if point.x > 0 {
            neighbors.push(Point {
                x: point.x - 1,
                y: point.y,
            });
        }

        if point.x < self.width - 1 {
            neighbors.push(Point {
                x: point.x + 1,
                y: point.y,
            });
        }

        if point.y > 0 {
            neighbors.push(Point {
                x: point.x,
                y: point.y - 1,
            });
        }

        if point.y < self.height - 1 {
            neighbors.push(Point {
                x: point.x,
                y: point.y + 1,
            });
        }

        neighbors
    }

    fn get_square_type(&self, point: VirtualPoint) -> SquareType {
        let normalized = Point {
            x: point.x.rem_euclid(self.width as i64) as usize,
            y: point.y.rem_euclid(self.height as i64) as usize,
        };

        self.squares[normalized.y][normalized.x]
    }

    fn get_virtual_neighbors(&self, point: VirtualPoint) -> Vec<VirtualPoint> {
        let mut neighbors = vec![];

        neighbors.push(VirtualPoint {
            x: point.x - 1,
            y: point.y,
        });

        neighbors.push(VirtualPoint {
            x: point.x + 1,
            y: point.y,
        });

        neighbors.push(VirtualPoint {
            x: point.x,
            y: point.y - 1,
        });

        neighbors.push(VirtualPoint {
            x: point.x,
            y: point.y + 1,
        });

        neighbors
    }
}

fn main() {
    assert_eq!(16, part1(&test_input(), 6));
    assert_eq!(3697, part1(&input(), 64));
    assert_eq!(0, part2(&input(), 26_501_365));
}

fn part1(input: &str, steps: usize) -> usize {
    let garden = parse(input);

    let mut destinations: HashSet<Point> = HashSet::new();
    destinations.insert(garden.start);

    for _ in 0..steps {
        let mut next_destinations: HashSet<Point> = HashSet::new();

        for destination in destinations.iter() {
            for neighbor in garden.get_bounded_neighbors(*destination) {
                if garden.get_square_type(neighbor.into()) != SquareType::Rocks {
                    next_destinations.insert(neighbor);
                }
            }
        }

        destinations = next_destinations;
    }

    destinations.len()
}

fn part2(input: &str, steps: usize) -> usize {
    let garden = parse(input);

    let mut destinations: HashSet<VirtualPoint> = HashSet::new();
    destinations.insert(garden.start.into());

    for i in 0..steps {
        let mut next_destinations: HashSet<VirtualPoint> = HashSet::new();

        for destination in destinations.iter() {
            for neighbor in garden.get_virtual_neighbors(*destination) {
                if garden.get_square_type(neighbor) != SquareType::Rocks {
                    next_destinations.insert(neighbor);
                }
            }
        }

        destinations = next_destinations;
    }

    destinations.len()
}

fn parse(input: &str) -> Garden {
    let squares: Vec<Vec<SquareType>> = input
        .split("\n")
        .map(|line| {
            line.chars()
                .map(|char| match char {
                    'S' => SquareType::Start,
                    '.' => SquareType::Garden,
                    '#' => SquareType::Rocks,
                    other => panic!("'{other}' cannot be parsed into a SquareType"),
                })
                .collect::<Vec<SquareType>>()
        })
        .collect();

    let width = squares[0].len();
    let height = squares.len();

    let start = (0..height)
        .flat_map(|y| (0..width).map(move |x| (x, y)))
        .find(|&(x, y)| squares[y][x] == SquareType::Start)
        .map(|(x, y)| Point { x, y })
        .unwrap();

    Garden {
        squares,
        width,
        height,
        start,
    }
}

#[allow(dead_code)]
fn test_input() -> String {
    "...........
.....###.#.
.###.##..#.
..#.#...#..
....#.#....
.##..S####.
.##..#...#.
.......##..
.##.#.####.
.##..##.##.
..........."
        .to_string()
}

#[allow(dead_code)]
fn input() -> String {
    "...................................................................................................................................
....#..#...##..##........#...#.#.........#.....#.#....................#..###.#.#...#........##......#.#.......#............#.......
.#...#........................#.....#.#..............#....................#..#....................#...............##..#...##.#.....
....#......#..#.#.....#...............#........#........#.#...............#....#..#..#..##........................#.#...#..........
......................................#...#......#....#..................#.#......................#.....#....#....#.#....#....#....
..#.....#....#....#.#....#...#...#..............##..#...........#..................#.......#.......#...#....##...#.........#.......
....##..........#.........#.....#...#.#.#.......#.#...#............................#..#.............#.#............................
............#.#...............................#.....#............................#......#.......#........#.......#.....#...#.#.....
....#.......#........#......................#....#............#....#..........................#....#......##.....#...........##....
...#.#.#..##...........................#........................#...#.........##.....#...#.#..............#.#.....#.#...##..#......
..#.....#..#.................................#...#...........##.....#...........#........#.#..#..........##....#..#.#..............
....##..#.#...#..#...................#...#...#...............#.....#......................................#............#.......#...
............#..#...##....#.#..#............#...#.........##.......#........................#..............###.#...........#......#.
.......#..#......#...#.##..#...#....#.#.......................#.#.####....#...................#...#.........##.....##...........#..
.....#..#..............#....##..#....#.................#.#....#.....#...............#....#...................................#.....
..#.......#..#....##......#.....##........#...........#.#...........................#.#.....#...................###...........#..#.
.#....###.....#......#......#.........#......................#.#..........................##...#..#.............##...#...#.#.......
...#..##..#...................#.....#.#..#..#.........##....#..............#.#...........##.....#.......##..............#....#...#.
........#..............#...................................##........#....#...........................#...............#.......#.##.
.......#......#.............#..........#.................#.....##....##...##............##....................#.#.#........#....##.
...............#...........#..#.....#...............#......#.......#...#..#.##.............#.#..............##....#.........###....
....#.....#..##.................................#.....##........#...................................#....#...#.........#..#......#.
............#.........#....#...#.......................#.##.....#...................................#....#.....#..#.......#.....#..
...##..........#.#.....#..#........##....................#...............#..#..#........................#....#............#..#.....
...................#.....#......................#.#............#...........##......................#..#............#.....##........
...#.......##......#......#....#.............#...#............#...............#...................#.#.##........................#..
..#..#........##..#.#...#..#..#..##........#.#...............#........................#............#...#.......#.........#..#......
..................#..#..#.....#..................#.#.#..#...............#...#..###..#........................#.....#...#.......#...
............#.......##..........#..............#.....#.#...........#........##...##..##.#..........#.............#..#.#............
..........................#....#...........#.............#...........#....#......##...............#....#.....#....#.##.....#.#...#.
.#........#.............#........................#.#........##.#......#...........#.....##............###.....#.....#.....#........
......#..........#......#..#.......................#......................##.....#..#.......#........#....#.#..#..#.......#......#.
.....#........#..#.....#..#.............#.................#.........#..................#...#..........##....#.#.#..#.##........###.
...#......#.#.............#..............#.............#...#..#...##.#..#..........##......##..............##..#.#...#.........#...
......##..#......#.#....#.##.......#......#.#...................#.......#.....#..........................#........#...........#....
...#...............##.............#.............................#.......#.............#....#....................................#..
..#.#....#.#.....#.#...#..........#..#................#.....#........#.#...............#........#........................#....#....
....#....#.......#...............#..........##.#..................#...#...............#.#....#..............#......#.......#....##.
..#..................#......................#...#..##.....##.###......#.###...........#..#.............................##.......##.
..#..##...#..#....................#....#.#.#..#.#.#..#.#...##......#.#.#....#..........##.#..##.#..#..............##...............
.....#..............#.........................###.....##...............#.....#.....#..#......###.....#.............................
.......##....................................#.........#..#...#...##......#......#.#.#...#......##...#.......................#.#...
.#....#....#.......#............##.....................#.......#...#..#.......#...#..#...#.....................................#...
.#...#.......#..#...............##...........#....#.....##...#..........#.....#...#.........##....#..#.....................#..#.##.
......##..................#.##...#....#.................#...#.#........##.......#.....#........#.......#...............#..#....#...
.#........##.#..............#.....#...........#...#...#.#..#.#...........#....#.......#.....#...##.....................#.#...##..#.
......#..#..#.#........#...#......#........#.#.........##...........#............#..........#......................#..#..#.....#...
.#.......#..#.........#.#....#.#.##...........##.....#........#.#..........#......#..............#...#..#..............#..#........
.....#....#............#.#...........#..#.#..#............#...........#......#.#...........#...#................................#..
....##.................#.....##.....#.....................#..........#.#.#...#.....#...............#.....#.#.............#.........
......#...............#.#.#......#...##..........#...........##....#.............#.........#......#......#...................#.##..
.....#............#.......#.#.............#....#.......#..........#.##.#...#........##......#.....#.#...#..........................
....#....................#................#..#....#....##..#...#.....#........#..#.........#....#.......#......#.............#...#.
.#...#................#...#....................#.....#.....#........##........#....#.#...#...#..#..#.#...#..#......................
....#.........................#.....#..#..............##......#.#.....#............................#.#.....#.....#.................
......................#...##.........##........#..#.........#.....#...##...#..#.#...#..........................#.................#.
..#..#........#...#.......#....................#....#.......#.#.......#....#.......#.#.#.................#.....................##..
.#................#....#...............#.#..........#.......#...........#.##.#...#.....#..............#...#....#..#................
.#....................#................##.......#####......#..........#........#.............#.#.........#.#......#..#.............
..#.......#....#...#.#.................#.......#................#..#..#.....##..#.....................#..#....#....................
.........#.......##...#.#.........#.....#.........#.....#.#.#..##...#...#.......#....................#..#...#..#....#.#............
..............#.........#.....#.###....##...#.....#........##...#......#..........#...........#..##...#.....#.#........#...........
.........#.#..........#..........#.........#........##....#..##.........##......#..#..#........#.....#.....#.......................
.......#.#...........#........##.......#............#........#.#...............#..#.......#..#.........#.....#..#..#..#..#.........
.......#............#.#............#...........##..#.........#.....#......#..#...#.............................#......#..#.........
.................................................................S.................................................................
.......##....#...#......#...........#.........#.....#..#...........#.##....#.##..#........................................###......
.....................#...............#....#.........#..........#.....#..#.......#.......#...............#.#.....#..#...............
.........##..........#.....#.............#...#.........##..........##........##......#............#.#...##...#...#..#....#.#.......
............#..##........#..........#.##..............#................#..#..#..#...#.##........#......#.......#.......#.##........
.......................#.....#..#..#.....#....................#.............###.....#..#....#.......#...#.......#......#...........
.#........#.#.....#...#.#......#..#.#.#..#......##..........##..#.....#...............#............................................
.....................##..........#.....#.........#....#.........................#..........#...#.#.....#.....#...#.................
.##................#.......##...........#...#.#.........##..#.......#.......##................#........#...##.......#............#.
....................#.#.....#...#...#..#..##...##...#..................#......................#....##........................#.....
..#.............#...#.......#...#....#..#............#..#.#......................#.................#.#...#..#.....#.........#.#....
...................#.#......##.............#...............#..#.#......................#...............###..###..#..........#......
........#............#...#...#.#....#..#..........#..................#.........#.......#.........#..##......#..............#...#...
..##.............##.......##.#.#.#....#....#.#...#....................#..........#...#.......#..#..........#.#...............#.....
...#..............#.....#..............###......#........#..#.....#.......#...#..#.................#.#........#..........#.....#...
....#....#............#.#....#..........#............#.........##...............#.#................#...#...................#..#.#..
........#.#.........#....#.....#.....#.#..#.........................#..#.#.......##.#.........#......#..##....#........##.#........
......................#......#...........#......#......#.#................#...##.#....#......#.....#.................#...#.#...#...
.....#..#...................#...............###..........#.............#..#.#.....#....#....................................#.#.#..
.#.#.........#.........#......#.#...............#.....#..#......#.....#.#..#...##.........#...#....#............................#..
..#.#......#..............#.##.#..##....#.............#.....#....................###.....#...#..#.....................#.......#.#..
.#.#.........#.................#.#........#..##.........#..#.......#...##....#...#..........#.#...#..#.#...........#......#.###.##.
.........##..................#...#......##...##...#.............#..........#.....###......#...#...#.#.#.................##.#...#...
..........#...#..#...................#..#....##........#..........##............#......#........#.#.................#............#.
..#.....#......#..............#............................##..##.............##.......#.#..#.........#..........##...##.....#..#..
.............#..............................#.#........................#......##...............#..#................#.##...#........
...#..#.....#..##...#..................................#.....................#...#.....#.........#..........#........#...#.#.#.....
....#......#.##.....#..........#.....##.........#.#..#.........................................................#......#..##.#....#.
...................#............................#........#..#.................#.....#..#.......#..............##.#.....#...........
......#......#..#................#........#...#..#..............#......#....#.......#.....................#...........#....#...##..
..#..#.....#...#..#...............##.............#.#........#...........#.............##....#.#...........#.#.........###....##....
..#......#.#...#.........#...................................#........#...................................................#..#.....
.............#......#.......#........#.........#...........#....#..#...................##..............#.#...#.#...........#..#..#.
....#............#.....#.............#...#..........#.......#.....#......................#..#..........#.#....#...........#........
..........#.......##.....................##....##......#.............##.##...#..........#.#...................#..............##.#..
....#....#.........#.#..#..##.#....................#..............#.......#............................#.......#..........##....#..
..##.#.........#.......#...#..........................#.#.....#....#.....##......#....#...#...................................#....
..........#.....#..#....#...................#.....#.#...##..#.#................#.#...................##.........#........#....##...
.............#.........#.....#.............#.............##.............#.....#....#.................#...#.......#.#..#..#...#.#...
........##...#....#..........#......................#..#.#...........#........#..#.#..............#............#......#........#...
...#.#..#.#...............#..##..#..#.........#........#.#..........#.......#.........#........#.......#.......#..#....##.......#..
..#.......###.........#.....##.......#....................#..#......##.......#....##..........##........#.....................#....
.........#..#.....#.....#......#.....#........#...............#...#...#......#.................................#.#.#............##.
.....#.........#..#.........#..##......#...................##.....##.....#.....#............#.......#.....#..#..#..#..........#.#..
..........#.#.........#.......#..#...##......................................#..............#....##.#..#....#....#.##..............
...........###.#..........##...........................................#.........#.......#.....................#......##...........
...#........#.....#...................#.......................##.......#......#...........#..###.....#..#.......#........#.........
..##.....#..#..#.....#.................#.#.............#...##.........#................#.......................##.......#.....###..
..............##.#...#............#......#...........#..#.........#..#......#...........##....#....#.............##.#..............
.#..##.#.............#.....#.............................#.....#.........#.................##.#...#.....#.....#..#..#............#.
.#.#...#.##..........#..........#.......#.....................#..........##..............#.............#........#.#......#....#....
....#...................#.......#.....#................#.....#.....#.....#.............#.#.#..#.................#........#..#......
.............#...#.......#.#..#...##....#..#..#.........##.............#.............#.#.#.........#..................#............
............#..#...#..##....##..#.....#..........#.......##.#.......................................#.#..........................#.
..#................#...##.....#..........#...#...............#........................#....##.....#..............#...##.##.#..#.#..
....#.#...#.#.#.....#..#.##.#.##....#.#.##..#..................................##.......................##........#.#......##...#..
...#.....#.#..#..#.#.......#.......#..##.#.....#............#.#......##..............#.#...#.....#...#.#....#.........#.....#....#.
....###.#..............#.#.....##..........#......................#.#...............#.##.....#........#.#...#..#.#............#..#.
.......#.....#.#..............#..#..#........##.#.#...............#.....................#...#..#.##...........#.....#....#.#..#....
.......##..........#.#....#..#..#.......##.......#..................................#..#..........#............#....#......#.##....
.###.##.##........#.....#......#....#...................#.........#..................#...#..............#..#......#..........#..#..
.....##.........................#.....#.......#...#.....#.................##..#........#...................###.#......#..#....#....
..#........#........##......#..#.#..............#.........................#...###.#...#....##.#........#.#......#........#....##...
..........#.....#........#................##...........#...............###.....##...........#..#...#...#..##......#........#.#.....
.....#....#......................#.##.............#..#...#.#.............#............#..#..#.....#.......................#...###..
...................................................................................................................................".to_string()
}
