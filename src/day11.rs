use std::collections::{HashMap, HashSet};
use rayon::prelude::*;

type Point = (usize, usize);
type Route = Vec<Point>;

#[derive(Debug)]
struct GalaxyPair {
    origin: Point,
    destination: Point,
    route: Option<Route>,
    length: Option<usize>,
}

fn main() {
    assert_eq!(9605127, part1());
    assert_eq!(458191688761, part2());
}

fn part1() -> usize {
    let universe = input();
    let galaxies = find_galaxies(&universe);
    let galaxy_groups = make_galaxy_groups(&galaxies);
    let expansion_rate = 2;

    println!(
        "We found {} galaxies, which makes for {} smart pairs.",
        galaxies.len(),
        galaxy_groups.len()
    );

    let expansion_points = get_expansion_points(&universe);

    let pairs_with_shortest_paths: Vec<GalaxyPair> = galaxy_groups
        .iter()
        .flat_map(|(origin, destinations)| {
            let routes = find_shortest_path_dijkstras(
                &universe,
                origin,
                &destinations.iter().map(|&&foo| foo).collect(),
                expansion_rate,
                &expansion_points,
            );

            println!("Found all routes for origin {:?}", origin);

            destinations
                .iter()
                .map(|destination| GalaxyPair {
                    origin: **origin,
                    destination: **destination,
                    route: None,
                    length: Some(
                        routes
                            .iter()
                            .find(|route| route.0 == **destination)
                            .unwrap()
                            .1
                             .1,
                    ),
                })
                .collect::<Vec<_>>()
        })
        .collect();

    pairs_with_shortest_paths.iter().fold(0, |acc, path| {
        acc + path.length.expect("We should have set all lengths")
    })
}

fn get_expansion_points(universe: &String) -> Vec<Point> {
    let mut expansion_points = vec![];

    for (y, line) in universe.lines().enumerate() {
        if !line.chars().any(|ch| ch == '#') {
            expansion_points.extend((0..line.len()).map(|x| (x, y)));
        }
    }

    for x in (0..universe.lines().nth(0).unwrap().len())
        .into_iter()
        .filter(|i| {
            universe
                .lines()
                .all(|line| line.chars().nth(*i).unwrap() != '#')
        })
    {
        expansion_points.extend((0..universe.lines().count()).map(|y| (x, y)));
    }

    expansion_points
}

fn find_galaxies(universe: &String) -> Vec<Point> {
    let mut galaxies = vec![];

    for (y, line) in universe.lines().enumerate() {
        for (x, ch) in line.chars().enumerate() {
            if ch == '#' {
                galaxies.push((x, y));
            }
        }
    }

    galaxies
}

fn make_galaxy_groups(galaxy_coordinates: &Vec<Point>) -> Vec<(&Point, Vec<&Point>)> {
    let mut groups = vec![];

    for i in 0..galaxy_coordinates.len() {
        let mut destinations = vec![];
        for ii in (i + 1)..galaxy_coordinates.len() {
            destinations.push(&galaxy_coordinates[ii]);
        }

        if destinations.len() > 0 {
            groups.push((&galaxy_coordinates[i], destinations));
        }
    }

    groups
}

fn find_shortest_path_dijkstras(
    universe: &String,
    origin: &Point,
    destinations: &Vec<Point>,
    expansion_rate: usize,
    expansion_points: &Vec<Point>,
) -> Vec<(Point, (Route, usize))> {
    let mut nodes_discovered: HashMap<Point, (Vec<Point>, usize)> = HashMap::new();
    nodes_discovered.insert(*origin, (vec![*origin], 0));
    let mut destinations_discovered: HashMap<Point, (Route, usize)> = HashMap::new();

    let max_x = universe
        .lines()
        .nth(0)
        .expect("The universe should have a first line")
        .chars()
        .count()
        - 1;
    let max_y = universe.lines().count() - 1;

    let mut edge_nodes: HashSet<Point> = HashSet::new();

    edge_nodes.insert(*origin);

    loop {
        if destinations_discovered.len() == destinations.len() {
            return destinations_discovered.into_iter().collect();
        }

        let mut next_edge_nodes: HashSet<Point> = HashSet::new();

        for edge_node in &edge_nodes {
            for (x, y) in get_neighbors_bounded(&edge_node, &(0, 0), &(max_x, max_y)) {
                let new_dest = (x, y);

                let (mut new_path, mut new_length) =
                    nodes_discovered.get(&edge_node).unwrap().clone();

                new_path.push(new_dest);
                new_length += match expansion_points.contains(&new_dest) {
                    true => expansion_rate,
                    false => 1,
                };

                next_edge_nodes.insert(new_dest);

                if destinations.contains(&new_dest) {
                    if let Some((_, stored_length)) =
                        destinations_discovered.get(&new_dest)
                    {
                        if new_length < *stored_length {
                            destinations_discovered
                                .insert(new_dest, (new_path.clone(), new_length));
                        }
                    } else {
                        destinations_discovered.insert(new_dest, (new_path.clone(), new_length));
                    }
                }

                if let Some(node) = nodes_discovered.get(&(x, y)) {
                    if new_length < node.1 {
                        nodes_discovered.insert(new_dest, (new_path, new_length));
                    }
                } else {
                    nodes_discovered.insert(new_dest, (new_path, new_length));
                }
            }
        }

        edge_nodes = next_edge_nodes;
    }
}

fn get_neighbors_bounded(
    (x, y): &Point,
    (min_x, min_y): &Point,
    (max_x, max_y): &Point,
) -> Vec<Point> {
    let mut neighbors = vec![];

    if *x > *min_x {
        neighbors.push((*x - 1, *y));
    }

    if *x < *max_x {
        neighbors.push((*x + 1, *y));
    }

    if *y > *min_y {
        neighbors.push((*x, *y - 1));
    }

    if *y < *max_y {
        neighbors.push((*x, *y + 1));
    }

    neighbors
}

#[allow(dead_code)]
fn visualize_path_in_universe(universe: &String, path: &Route) {
    let mut output: String = "".to_owned();

    for (y, line) in universe.lines().enumerate() {
        for (x, ch) in line.chars().enumerate() {
            if path.first() == Some(&(x, y)) {
                output += "1";
            } else if path.last() == Some(&(x, y)) {
                output += "2";
            } else if path.contains(&(x, y)) {
                output += "+";
            } else {
                output += &ch.to_string();
            }
        }
        output += "\n";
    }

    println!("{output}\n----------------------------");
}

fn part2() -> usize {
    let universe = input();
    let galaxies = find_galaxies(&universe);
    let galaxy_groups = make_galaxy_groups(&galaxies);
    let expansion_rate = 1_000_000;

    println!(
        "We found {} galaxies, which makes for {} smart pairs.",
        galaxies.len(),
        galaxy_groups.len()
    );

    let expansion_points = get_expansion_points(&universe);

    let pairs_with_shortest_paths: Vec<GalaxyPair> = galaxy_groups
        .par_iter()
        .flat_map(|(origin, destinations)| {
            let routes = find_shortest_path_dijkstras(
                &universe,
                origin,
                &destinations.iter().map(|&&foo| foo).collect(),
                expansion_rate,
                &expansion_points,
            );

            println!("Found all routes for origin {:?}", origin);

            destinations
                .iter()
                .map(|destination| GalaxyPair {
                    origin: **origin,
                    destination: **destination,
                    route: None,
                    length: Some(
                        routes
                            .iter()
                            .find(|route| route.0 == **destination)
                            .unwrap()
                            .1
                             .1,
                    ),
                })
                .collect::<Vec<_>>()
        })
        .collect();

    for path in &pairs_with_shortest_paths {
        println!(
            "Path: from ({}, {}) to ({}, {}). Length: {}. Route: {:?}",
            path.origin.0,
            path.origin.1,
            path.destination.0,
            path.destination.1,
            path.length.unwrap_or(99),
            path.route.clone()
        );
    }

    pairs_with_shortest_paths.iter().fold(0, |acc, path| {
        acc + path.length.expect("We should have set all lengths")
    })
}

#[derive(Debug, PartialEq, Eq, PartialOrd, Ord)]
struct MinDistanceNode {
    point: Point,
    distance: usize,
}

#[allow(dead_code)]
fn test_input() -> String {
    "...#......
.......#..
#.........
..........
......#...
.#........
.........#
..........
.......#..
#...#....."
        .to_string()
}

#[allow(dead_code)]
fn input() -> String {
    "...........................#.............#..........#.........#..................#.......#.............................................#....
..............#...........................................................................................#...............#.................
.....................#......................................................................................................................
...................................#................................#................................................#....................#.
.................#.......................................................#..........#..................#.............................#......
...............................................................................................#.................#..........................
......................................................#........................#........................................#...................
........#.....................................................#...........................#.................#...............................
.........................................#.....#...............................................................................#............
...........................#.........................................................#...................................................#..
.....#................................................................#............................................................#........
.............#..........................................#.......................................#.................#.........#...............
............................................#...............................................................................................
.#...............#.....................#....................................#.............................#................................#
............................#....................#..........................................................................................
...................................................................................................#..........#.............................
.......#............#.........................................#........#.........................................................#..........
..............#.................................................................#..........#............................#...................
................................#........................................................................................................#..
...............................................#.....................................................#...........#..........................
#...............................................................#...........................................................................
............#......#...................................#....................................................#.............#.........#.......
.......................................................................................#....................................................
....................................#........................#......#...........................#...........................................
.........#.....#.............#............#.....................................#.....................................#.....................
..........................................................................................................#.....#...............#..........#
........................................................#...................................................................................
..........................#.................................................................................................................
....#..................................................................#..................................................#.................
.....................#..........................................#...........................#.........#.....................................
...........#.........................#.......................................#......#.................................................#.....
#...............................................................................................#..................#............#...........
............................#.............#.........#.......................................................................................
........#...........................................................#.......................................................................
.........................................................................#..........................#.......................................
..#..........#............................................#.....#.....................#...............................#.....................
.....................................#...............................................................................................#......
....................#......................#....................................................................................#...........
.....#......................................................................................................................................
................................#....................#............................#.........................................................
........................#......................................................................#.............................#..............
.......................................................................#....................................................................
..............#.................................#......................................................#.......#..................#.......#.
............................................................#............................#..................................................
..........................................................................................................................#.................
..#.................#.........#............................................#.......#........................................................
.......#.............................................#........................................#.......................#.....................
...............................................................#.................................................................#..........
...........................#...............#.......................................................#.....................................#..
.................................#..............#...............................................................#...........................
...............#........................................................................#...................................................
.........................................................#......................................#..........#................................
..#......................................#................................#.................................................................
...............................#............................................................#..............................................#
..........#........#............................................#...............................................................#...........
................................................................................#..................#...........#..........#.................
..................................#........#................................................................................................
............................................................................................................................................
.....................#............................................#............................#.......#.....................#..............
............................#........................#.....................#..........#..........................#.....................#....
.........................................................................................................................#..................
.#.........#...........................#.......................#...................................#........................................
................#........#.....................................................................................................#..........#.
...........................................................................................#.................#..............................
...............................#......................................#............................................#........................
.........................................#.......#......................................................#...................................
..........#..................................................#.................#............................................................
#.......................#..............................................................#...........................................#.......#
.................................#......................#........................................................#........#.................
............................................................................................................................................
...............................................#...............................................#............................................
................#.....................#.......................................#.............................................................
......................................................#...............#.....................................................................
...................................................................................#.............................................#..........
..................................................................#........#....................................#...........................
.#.......................................................#.................................#............#...................................
............................................................................................................................................
........#.......................#................................................#.........................................#................
..................#......#......................................................................#...........................................
......................................#...............#..........#.....................................................................#....
...#....................................................................................#...................................................
...............#..............................#.............................#...............................................................
...................................#..............................................................#.....#........................#.........#
.......#............#...................................................................................................#...................
...........................#.................................................................#................#.............................
.....................................................#...............................................#......................................
...........#..............................................#.................................................................................
..............................................#.................#...............#.........#.................................................
................#.......#...........#.................................#...................................#.................................
.....................................................................................#...........#...................#......................
........................................................#......................................................................#.......#....
.....#......................#...............................................................................................................
.............#........#..........................#..........................................................#.............#................#
............................................................................................................................................
........#............................#............................................#..........#..............................................
............................................#...................................................................#...........................
............................................................................................................................................
..#..............#......#.........................................#...............................#.........................................
....................................................#......................#.......................................................#......#.
...................................#........................#................................................................#..............
.....................................................................#...........#..........................................................
...............#.............................#...........................................................#..................................
..........#..............................................................................#.....#.................#..........................
.....................................................................................................................................#......
.#................................#.........................................................................#...............................
........................#.........................................#......#.........#................#.......................................
.................#........................................#..................................................................#..............
........................................#...................................................................................................
....#.....#........................................#............................................#...........................................
............................................................................................................................................
..............................................................................#.....................................#................#......
.....................#................................................................#.........................................#...........
.............................#.........#........#.........#.............#...........................#.......................................
................................................................#.........................#..................#............#.............#...
........#.......................................................................#...........................................................
........................#..................#............................................................#...................................
.....................................#.................................................#.........#................#.........................
...................................................#.....................#....................................................#............#
............................................................................................................................................
................#..............................................#.................#............................#.............................
....#........................#..........................#............#......................................................................
....................................#........................................................#..............................................
.......................#..........................................................................#.....#...........#............#..........
........#..................................#................#.............#...........................................................#.....
................................................#.......................................................................#..................#
..................#.................................................................#.......................................................
............#........................#...........................................................................#.............#............
...#........................................................................................................................................
..........................................#.................................#................#..............................................
.......................#............................#.............#...................................................#.............#.......
.................................#....................................................#........................#............................
.................................................................................#........................................................#.
..........................................................#.............................................#...................................
...#............#...........................................................................................................................
..............................................#...................................................#.........................................
.........................................................................#.....#.......#.........................................#..........
............#.........#......................................................................#........#.....................................
...........................#........................................#........................................#.......................#......
.....#.................................#..............#........#.....................................................#......................
...............................#............................................#........#....................................#.................".to_string()
}
